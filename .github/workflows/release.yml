name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build & Release
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: bun install

      - name: Typecheck
        run: bun run typecheck

      - name: Test
        run: bun test

      - name: Lint
        run: bun run lint

      - name: Build macOS arm64
        run: bun build src/exp.ts --compile --outfile dist/exp-darwin-arm64

      - name: Build macOS x64
        run: bun build src/exp.ts --compile --target=bun-darwin-x64 --outfile dist/exp-darwin-x64

      - name: Create archives
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          cd dist

          mkdir -p exp_${VERSION}_darwin_arm64
          cp exp-darwin-arm64 exp_${VERSION}_darwin_arm64/exp
          tar -czf exp_${VERSION}_darwin_arm64.tar.gz exp_${VERSION}_darwin_arm64

          mkdir -p exp_${VERSION}_darwin_x64
          cp exp-darwin-x64 exp_${VERSION}_darwin_x64/exp
          tar -czf exp_${VERSION}_darwin_x64.tar.gz exp_${VERSION}_darwin_x64

      - name: Generate checksums
        id: checksums
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          cd dist
          ARM64_SHA=$(shasum -a 256 exp_${VERSION}_darwin_arm64.tar.gz | cut -d' ' -f1)
          X64_SHA=$(shasum -a 256 exp_${VERSION}_darwin_x64.tar.gz | cut -d' ' -f1)
          echo "arm64_sha=${ARM64_SHA}" >> "$GITHUB_OUTPUT"
          echo "x64_sha=${X64_SHA}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | head -2 | tail -1)
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "${{ github.ref_name }}" ]; then
            echo "body=Initial release" >> "$GITHUB_OUTPUT"
          else
            CHANGELOG=$(git log --pretty=format:"- %s" "$PREV_TAG".."${{ github.ref_name }}" -- . ':!.github')
            EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
            echo "body<<$EOF" >> "$GITHUB_OUTPUT"
            echo "$CHANGELOG" >> "$GITHUB_OUTPUT"
            echo "$EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.body }}
          files: |
            dist/exp_${{ steps.checksums.outputs.version }}_darwin_arm64.tar.gz
            dist/exp_${{ steps.checksums.outputs.version }}_darwin_x64.tar.gz

      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.checksums.outputs.version }}"
          ARM64_SHA="${{ steps.checksums.outputs.arm64_sha }}"
          X64_SHA="${{ steps.checksums.outputs.x64_sha }}"

          cat > /tmp/exp.rb << FORMULA
          # typed: false
          # frozen_string_literal: true

          class Exp < Formula
            desc "Instant project forking via macOS APFS clonefile"
            homepage "https://github.com/thebrubaker/exp"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/thebrubaker/exp/releases/download/v${VERSION}/exp_${VERSION}_darwin_arm64.tar.gz"
                sha256 "${ARM64_SHA}"
              end
              if Hardware::CPU.intel?
                url "https://github.com/thebrubaker/exp/releases/download/v${VERSION}/exp_${VERSION}_darwin_x64.tar.gz"
                sha256 "${X64_SHA}"
              end
            end

            def install
              bin.install "exp"
            end

            test do
              system bin/"exp", "--version"
            end
          end
          FORMULA

          cd /tmp
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/digitalpine/homebrew-tap.git"
          cd homebrew-tap
          cp /tmp/exp.rb exp.rb
          git add exp.rb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update exp to ${VERSION}"
          git push
